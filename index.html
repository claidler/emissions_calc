<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Carbon Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #4B5563; }
        .input-group input, .input-group select {
            width: 100%; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #D1D5DB;
            box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .input-group input:focus, .input-group select:focus {
            outline: 2px solid transparent; outline-offset: 2px; border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: #3B82F6; color: white; }
        .btn-primary:hover { background-color: #2563EB; transform: translateY(-1px); }
        .btn-secondary { background-color: #6B7280; color: white; }
        .btn-secondary:hover { background-color: #4B5563; transform: translateY(-1px); }
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-danger:hover { background-color: #DC2626; transform: translateY(-1px); }
        .btn-success { background-color: #10B981; color: white; }
        .btn-success:hover { background-color: #059669; transform: translateY(-1px); }
        .btn-sm { padding: 0.5rem 1rem; font-weight: 500; }
        
        .hidden { display: none !important; }
        .section-card {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; /* lg */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .section-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .section-card-title { font-size: 1.125rem; /* xl */ font-weight: 600; color: #1F2937; }
        .section-card-description { font-size: 0.875rem; /* sm */ color: #6B7280; margin-bottom: 1rem; flex-grow: 1; }
        .status-icon { width: 1.5rem; height: 1.5rem; margin-left: 0.5rem; }
        .status-icon-incomplete { color: #EF4444; /* red-500 */ }
        .status-icon-complete { color: #10B981; /* green-500 */ }

        .section-edit-view {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }
        .section-edit-view h2 { font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 1.5rem; }
        .dynamic-section-block { /* For items within a section like country, intervention */
            border: 1px solid #E5E7EB; padding: 1.5rem; margin-bottom: 1rem;
            border-radius: 0.5rem; background-color: #F9FAFB;
        }
        .nested-group { margin-left: 1rem; padding-left: 1rem; border-left: 2px solid #D1D5DB; margin-top: 1rem; padding-top: 1rem; }

        /* Result page styling */
        .result-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .result-card h3 { font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-bottom: 1rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 0.5rem; }
        .result-item { margin-bottom: 0.75rem; display: flex; justify-content: space-between; }
        .result-item strong { color: #374151; }
        .result-item span { color: #4B5563; }
        .loading-indicator { display: none; margin: 2rem auto; text-align: center; font-size: 1.125rem; color: #3B82F6; }
        
        /* Chart container styling */
        #emissionsChartContainer {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            position: relative; /* Ensures canvas stays within bounds */
            height: 400px; /* Fixed height for the chart container */
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 min-h-screen">

    <div id="overviewPage" class="container mx-auto max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Clinical Trial Carbon Calculator</h1>
            <div class="flex justify-center space-x-4">
                <button id="newAssessmentButton" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2M9 15h4.581" /></svg>
                    New Assessment
                </button>
                <button id="calculateResultsButtonOverview" class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 4a1 1 0 011 1v3a1 1 0 11-2 0V9a1 1 0 011-1zm-3 0a1 1 0 011 1v3a1 1 0 11-2 0V9a1 1 0 011-1zm-4-3a1 1 0 100 2h.01a1 1 0 100-2H7zm-2 2a1 1 0 011-1h.01a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Calculate Results
                </button>
            </div>
        </header>

        <div id="sectionsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </div>

    <div id="sectionEditViewsContainer" class="container mx-auto max-w-3xl hidden">
        <div id="edit-generalInfo" class="section-edit-view hidden">
            <h2>General Information</h2>
            <form id="form-generalInfo" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group"><label for="gi-currencyCode">Currency Code:</label><input type="text" id="gi-currencyCode"></div>
                    <div class="input-group"><label for="gi-trialName">Trial Name:</label><input type="text" id="gi-trialName"></div>
                </div>
                <div class="input-group"><label for="gi-individualName">Individual Name:</label><input type="text" id="gi-individualName"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group"><label for="gi-startDate">Start Date:</label><input type="datetime-local" id="gi-startDate"></div>
                    <div class="input-group"><label for="gi-endDate">End Date:</label><input type="datetime-local" id="gi-endDate"></div>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="btn btn-secondary cancel-section-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary save-section-edit">Save Section</button>
                </div>
            </form>
        </div>

        <div id="edit-countryDetails" class="section-edit-view hidden">
            <h2>Country Details</h2>
            <form id="form-countryDetails" class="space-y-4">
                <div id="cd-itemsContainer" class="space-y-6"></div>
                <button type="button" id="cd-addItemButton" class="btn btn-secondary mt-4">Add Country Detail</button>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="btn btn-secondary cancel-section-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary save-section-edit">Save Section</button>
                </div>
            </form>
        </div>

        <div id="edit-interventions" class="section-edit-view hidden">
            <h2>Interventions</h2>
            <form id="form-interventions" class="space-y-4">
                <div id="int-itemsContainer" class="space-y-6"></div>
                <button type="button" id="int-addItemButton" class="btn btn-secondary mt-4">Add Intervention</button>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="btn btn-secondary cancel-section-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary save-section-edit">Save Section</button>
                </div>
            </form>
        </div>

        <div id="edit-testLabKits" class="section-edit-view hidden">
            <h2>Test Lab Kits</h2>
            <form id="form-testLabKits" class="space-y-4">
                <div id="tlk-itemsContainer" class="space-y-6"></div>
                <button type="button" id="tlk-addItemButton" class="btn btn-secondary mt-4">Add Test Lab Kit</button>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="btn btn-secondary cancel-section-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary save-section-edit">Save Section</button>
                </div>
            </form>
        </div>
        
        <div id="edit-otherParticipants" class="section-edit-view hidden">
            <h2>Other Participant Devices</h2>
            <form id="form-otherParticipants" class="space-y-4">
                <div id="opd-itemsContainer" class="space-y-6"></div>
                <button type="button" id="opd-addItemButton" class="btn btn-secondary mt-4">Add Other Participant Device</button>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" class="btn btn-secondary cancel-section-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary save-section-edit">Save Section</button>
                </div>
            </form>
        </div>
    </div>

    <div id="resultsPage" class="container mx-auto max-w-4xl hidden mt-8">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Calculation Results</h1>
                <button id="backToOverviewButton" class="btn btn-secondary">Back to Overview</button>
            </div>
            <div id="emissionsChartContainer" class="mb-6"> 
                <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Emissions by Section (kgCO2e)</h3>
                <canvas id="emissionsChart"></canvas>
            </div>
            <div id="resultsContent" class="space-y-6"></div>
            <div id="resultsLoadingIndicator" class="loading-indicator">Calculating...</div>
            <pre id="rawApiResponse" class="mt-8 bg-gray-800 text-white p-4 rounded-md text-xs overflow-x-auto hidden"></pre>
            <div class="mt-6 flex space-x-3">
                <button id="toggleRawJsonButton" class="btn btn-sm btn-secondary">Show Raw JSON</button>
                <button id="exportCsvButton" class="btn btn-sm btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Export to CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const overviewPage = document.getElementById('overviewPage');
        const sectionsGrid = document.getElementById('sectionsGrid');
        const sectionEditViewsContainer = document.getElementById('sectionEditViewsContainer');
        const resultsPage = document.getElementById('resultsPage');
        const newAssessmentButton = document.getElementById('newAssessmentButton');
        const calculateResultsButtonOverview = document.getElementById('calculateResultsButtonOverview');
        const resultsContent = document.getElementById('resultsContent');
        const resultsLoadingIndicator = document.getElementById('resultsLoadingIndicator');
        const backToOverviewButton = document.getElementById('backToOverviewButton');
        const rawApiResponseElement = document.getElementById('rawApiResponse');
        const toggleRawJsonButton = document.getElementById('toggleRawJsonButton');
        const emissionsChartCanvas = document.getElementById('emissionsChart');
        const exportCsvButton = document.getElementById('exportCsvButton'); // CSV Export Button

        const API_ENDPOINT = 'https://clinicaltrialcarbon.org/api/Calculator/CalculateResults';
        const LOCAL_STORAGE_KEY_DATA = 'clinicalTrialFormData_v2';
        const LOCAL_STORAGE_KEY_STATUS = 'clinicalTrialFormStatus_v2';

        let emissionsChartInstance = null;
        let appData = {}; 
        let sectionCompletionStatus = {}; 
        let latestApiResult = null; // To store the latest API result for CSV export

        // --- Helper Functions (Defined First) ---
        function createResultItem(label, value, unit = '', additionalClasses = '') {
            const valStr = (value === null || typeof value === 'undefined' || value === "") ? 'N/A' : `${value} ${unit}`.trim();
            return `<div class="result-item ${additionalClasses}"><strong>${label}:</strong> <span>${valStr}</span></div>`;
        }

        function createDebugLogs(logs) {
            if (!logs || logs.length === 0) return '';
            return `<div class="debug-log"><strong>Debug Logs:</strong><ul class="list-disc list-inside ml-4">${logs.map(log => `<li>${log}</li>`).join('')}</ul></div>`;
        }
        
        function showPage(pageId) {
            overviewPage.classList.add('hidden');
            sectionEditViewsContainer.classList.add('hidden');
            resultsPage.classList.add('hidden');
            document.getElementById(pageId)?.classList.remove('hidden');
        }

        function showSectionEditView(sectionId) {
            sectionEditViewsContainer.classList.remove('hidden');
            sections.forEach(s => {
                const view = document.getElementById(s.editViewId);
                if (s.id === sectionId) view?.classList.remove('hidden');
                else view?.classList.add('hidden');
            });
            showPage('sectionEditViewsContainer');
        }

        function renderOverviewCards() {
            sectionsGrid.innerHTML = '';
            sections.forEach(section => {
                const card = document.createElement('div');
                card.className = 'section-card';
                const isComplete = sectionCompletionStatus[section.id] === true;
                const statusIconSvg = isComplete ? 
                    `<svg class="status-icon status-icon-complete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>` :
                    `<svg class="status-icon status-icon-incomplete" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6H4.5A9.75 9.75 0 004.5 15H3.598A11.959 11.959 0 0112 2.036zM12 9H7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                card.innerHTML = `
                    <div class="section-card-header">
                        <h3 class="section-card-title">${section.title}</h3>
                        ${statusIconSvg}
                    </div>
                    <p class="section-card-description">${section.description}</p>
                    <button class="btn btn-secondary btn-sm edit-section-button" data-section-id="${section.id}">Edit</button>
                `;
                sectionsGrid.appendChild(card);
            });
            document.querySelectorAll('.edit-section-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sectionId = e.currentTarget.dataset.sectionId;
                    loadSectionFormData(sectionId);
                    showSectionEditView(sectionId);
                });
            });
        }
        
        // --- Section Definitions ---
        const sections = [
            { id: 'generalInfo', title: '2.2.1 General Information', description: 'Enter general trial information like name, dates, and assessor.', formId: 'form-generalInfo', editViewId: 'edit-generalInfo', fields: ['gi-currencyCode', 'gi-trialName', 'gi-individualName', 'gi-startDate', 'gi-endDate'], required: true },
            { id: 'countryDetails', title: '2.2.2 Countries Trial Undertaken', description: 'Define countries, number of participants, and site visit details.', formId: 'form-countryDetails', editViewId: 'edit-countryDetails', dynamicItemsContainerId: 'cd-itemsContainer', addItemButtonId: 'cd-addItemButton', itemCreationFn: 'createCountryDetailItemForm', itemDataCollectionFn: 'collectCountryDetailItemData', required: true },
            { id: 'interventions', title: '2.3 Interventional Product (IP)', description: 'Detail the interventional product, type, quantity, and supply specifics.', formId: 'form-interventions', editViewId: 'edit-interventions', dynamicItemsContainerId: 'int-itemsContainer', addItemButtonId: 'int-addItemButton', itemCreationFn: 'createInterventionItemForm', itemDataCollectionFn: 'collectInterventionItemData', required: false },
            { id: 'testLabKits', title: '2.4 Lab Kits', description: 'Provide information about lab kits, including name, supply, and quantity.', formId: 'form-testLabKits', editViewId: 'edit-testLabKits', dynamicItemsContainerId: 'tlk-itemsContainer', addItemButtonId: 'tlk-addItemButton', itemCreationFn: 'createTestLabKitItemForm', itemDataCollectionFn: 'collectTestLabKitItemData', required: false },
            { id: 'otherParticipants', title: '2.5 Other Participant or Site Devices', description: 'Define devices used, such as type, quantity, and supply information.', formId: 'form-otherParticipants', editViewId: 'edit-otherParticipants', dynamicItemsContainerId: 'opd-itemsContainer', addItemButtonId: 'opd-addItemButton', itemCreationFn: 'createOtherParticipantItemForm', itemDataCollectionFn: 'collectOtherParticipantItemData', required: false },
        ];
        
        // --- Data Handling & Local Storage ---
        function initializeAppData() {
            const defaultData = {
                generalInfo: { 'gi-currencyCode': "EUR", 'gi-trialName': "Test", 'gi-individualName': "Some Test", 'gi-startDate': "2025-05-19T23:00", 'gi-endDate': "2025-05-21T23:00" },
                countryDetails: [{ countryCode: "AL", numberOfSubjects: 2, siteVisit_numberOfSubjectSiteVisits: 2, siteVisit_durationOfVisit: 2, remoteVirtualVisit_numberOfRemoveVirtualVists: 2, remoteVirtualVisit_durationOfVisit: 2, _id: crypto.randomUUID() }],
                interventions: [{ 
                    productName: "Test Intervention", productType: 1, quantityType: 2, quantity: 2, 
                    oversupplyAmount: null, supplyCountry: null, kitQuantityType: null, kitQuantity: null, kitOverSupplyAmount: null, kitWeight: null, 
                    _id: crypto.randomUUID() 
                }],
                testLabKits: [{ 
                    productName: "Test Lab Kit Alpha", supplyCountry: null, kitQuantityType: 1, kitQuantity: 123, kitOverSupplyAmount: null, kitWeight: 123, 
                    _id: crypto.randomUUID() 
                }],
                otherParticipants: [{ 
                    productName: "Participant Device X", supplyCountry: null, productType: "Device_(smartphone)", itemWeight: 0.182, 
                    quantityType: 1, quantity: 1, overSupplyAmount: null, hoursUsagePerDevicePerParticipant: 2, 
                    _id: crypto.randomUUID() 
                }]
            };
            appData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_DATA)) || defaultData;
            
            const defaultStatus = {};
            sections.forEach(s => defaultStatus[s.id] = false);
            const storedStatus = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_STATUS));
            if (storedStatus) {
                sectionCompletionStatus = storedStatus;
                sections.forEach(s => {
                    if (typeof sectionCompletionStatus[s.id] === 'undefined') {
                        sectionCompletionStatus[s.id] = false;
                    }
                });
            } else {
                sectionCompletionStatus = defaultStatus;
            }
        }

        function saveAppData() {
            localStorage.setItem(LOCAL_STORAGE_KEY_DATA, JSON.stringify(appData));
            localStorage.setItem(LOCAL_STORAGE_KEY_STATUS, JSON.stringify(sectionCompletionStatus));
        }

        function resetAssessment() {
            if (confirm("Are you sure you want to start a new assessment? All current data will be lost.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY_DATA);
                localStorage.removeItem(LOCAL_STORAGE_KEY_STATUS);
                initializeAppData();
                renderOverviewCards();
                showPage('overviewPage');
            }
        }

        // --- Section Form Handling ---
        function loadSectionFormData(sectionId) {
            const sectionDef = sections.find(s => s.id === sectionId);
            if (!sectionDef) return;

            if (sectionDef.dynamicItemsContainerId && !Array.isArray(appData[sectionId])) {
                appData[sectionId] = []; 
            }
            const sectionData = appData[sectionId] || (sectionDef.dynamicItemsContainerId ? [] : {});
            const form = document.getElementById(sectionDef.formId);

            if (sectionDef.fields) { 
                sectionDef.fields.forEach(fieldId => {
                    const input = form.querySelector(`#${fieldId}`);
                    if (input) {
                        if (input.type === 'datetime-local') {
                            input.value = (sectionData[fieldId] && typeof sectionData[fieldId] === 'string') ? sectionData[fieldId].slice(0, 16) : '';
                        } else {
                            input.value = sectionData[fieldId] || '';
                        }
                    }
                });
            } else if (sectionDef.dynamicItemsContainerId) { 
                const container = form.querySelector(`#${sectionDef.dynamicItemsContainerId}`);
                container.innerHTML = ''; 
                
                if (sectionId === 'countryDetails') cdItemCounter = 0;
                if (sectionId === 'interventions') intItemCounter = 0;
                if (sectionId === 'testLabKits') tlkItemCounter = 0;
                if (sectionId === 'otherParticipants') opdItemCounter = 0;

                const items = sectionData; 
                if (items.length === 0 && typeof window[sectionDef.itemCreationFn] === 'function') {
                     window[sectionDef.itemCreationFn](container, {}); 
                } else {
                    items.forEach(itemData => {
                        if (typeof window[sectionDef.itemCreationFn] === 'function') {
                            window[sectionDef.itemCreationFn](container, itemData);
                        }
                    });
                }
            }
        }

        function handleSaveSection(e) {
            e.preventDefault();
            const form = e.target.closest('form');
            const sectionEditView = form.closest('.section-edit-view');
            const sectionId = sectionEditView.id.replace('edit-', '');
            const sectionDef = sections.find(s => s.id === sectionId);

            if (!sectionDef) return;

            let currentSectionData;
            if (sectionDef.fields) { 
                currentSectionData = {};
                sectionDef.fields.forEach(fieldId => {
                    const input = form.querySelector(`#${fieldId}`);
                    if (input) currentSectionData[fieldId] = input.value;
                });
            } else if (sectionDef.dynamicItemsContainerId) { 
                currentSectionData = []; 
                const itemsContainer = form.querySelector(`#${sectionDef.dynamicItemsContainerId}`);
                itemsContainer.querySelectorAll('.dynamic-section-block').forEach(itemBlock => {
                    if (typeof window[sectionDef.itemDataCollectionFn] === 'function') {
                        const itemData = window[sectionDef.itemDataCollectionFn](itemBlock);
                        currentSectionData.push(itemData);
                    }
                });
            }
            
            appData[sectionId] = currentSectionData;
            sectionCompletionStatus[sectionId] = true; 
            saveAppData();
            renderOverviewCards();
            showPage('overviewPage');
        }

        // --- Dynamic Item Creation for Sections ---
        let cdItemCounter = 0;
        function createCountryDetailItemForm(container, data = {}) {
            cdItemCounter++;
            const itemId = data._id || crypto.randomUUID(); 
            const itemDiv = document.createElement('div');
            itemDiv.className = 'dynamic-section-block';
            itemDiv.id = `cd-item-${cdItemCounter}`; 
            itemDiv.dataset.itemId = itemId; 

            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-md font-semibold">Country #${cdItemCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm remove-dynamic-item">Remove</button>
                </div>
                <div class="input-group"><label>Country Code:</label><input type="text" name="countryCode" value="${data.countryCode || ''}"></div>
                <div class="input-group"><label>Number of Subjects:</label><input type="number" name="numberOfSubjects" value="${data.numberOfSubjects || 0}" min="0"></div>
                <div class="nested-group">
                    <h5 class="text-sm font-medium">Site Visit</h5>
                    <div class="input-group"><label># Site Visits:</label><input type="number" name="siteVisit_numberOfSubjectSiteVisits" value="${data.siteVisit_numberOfSubjectSiteVisits || 0}" min="0"></div>
                    <div class="input-group"><label>Duration (hrs):</label><input type="number" name="siteVisit_durationOfVisit" value="${data.siteVisit_durationOfVisit || 0}" min="0"></div>
                </div>
                <div class="nested-group">
                    <h5 class="text-sm font-medium">Remote Visit</h5>
                    <div class="input-group"><label># Remote Visits:</label><input type="number" name="remoteVirtualVisit_numberOfRemoveVirtualVists" value="${data.remoteVirtualVisit_numberOfRemoveVirtualVists || 0}" min="0"></div>
                    <div class="input-group"><label>Duration (hrs):</label><input type="number" name="remoteVirtualVisit_durationOfVisit" value="${data.remoteVirtualVisit_durationOfVisit || 0}" min="0"></div>
                </div>
            `;
            itemDiv.querySelector('.remove-dynamic-item').addEventListener('click', () => itemDiv.remove());
            container.appendChild(itemDiv);
        }

        function collectCountryDetailItemData(itemBlock) {
            return {
                _id: itemBlock.dataset.itemId,
                countryCode: itemBlock.querySelector('[name="countryCode"]').value,
                numberOfSubjects: parseInt(itemBlock.querySelector('[name="numberOfSubjects"]').value) || 0,
                siteVisit_numberOfSubjectSiteVisits: parseInt(itemBlock.querySelector('[name="siteVisit_numberOfSubjectSiteVisits"]').value) || 0,
                siteVisit_durationOfVisit: parseInt(itemBlock.querySelector('[name="siteVisit_durationOfVisit"]').value) || 0,
                remoteVirtualVisit_numberOfRemoveVirtualVists: parseInt(itemBlock.querySelector('[name="remoteVirtualVisit_numberOfRemoveVirtualVists"]').value) || 0,
                remoteVirtualVisit_durationOfVisit: parseInt(itemBlock.querySelector('[name="remoteVirtualVisit_durationOfVisit"]').value) || 0,
            };
        }
        
        let intItemCounter = 0;
        function createInterventionItemForm(container, data = {}) {
            intItemCounter++;
            const itemId = data._id || crypto.randomUUID();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'dynamic-section-block';
            itemDiv.id = `int-item-${intItemCounter}`;
            itemDiv.dataset.itemId = itemId;
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2"><h4 class="text-md font-semibold">Intervention #${intItemCounter}</h4><button type="button" class="btn btn-danger btn-sm remove-dynamic-item">Remove</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                    <div class="input-group"><label>Product Name:</label><input type="text" name="productName" value="${data.productName || ''}"></div>
                    <div class="input-group"><label>Product Type (Num):</label><input type="number" name="productType" value="${data.productType || ''}"></div>
                    <div class="input-group"><label>Quantity Type (Num):</label><input type="number" name="quantityType" value="${data.quantityType || ''}"></div>
                    <div class="input-group"><label>Quantity:</label><input type="number" name="quantity" value="${data.quantity || ''}" min="0"></div>
                    <div class="input-group"><label>Oversupply Amount:</label><input type="number" name="oversupplyAmount" value="${data.oversupplyAmount || ''}" placeholder="Optional" min="0"></div>
                    <div class="input-group"><label>Supply Country:</label><input type="text" name="supplyCountry" value="${data.supplyCountry || ''}" placeholder="Optional"></div>
                    <div class="input-group"><label>Kit Quantity Type (Num):</label><input type="number" name="kitQuantityType" value="${data.kitQuantityType || ''}" placeholder="Optional"></div>
                    <div class="input-group"><label>Kit Quantity:</label><input type="number" name="kitQuantity" value="${data.kitQuantity || ''}" placeholder="Optional" min="0"></div>
                    <div class="input-group"><label>Kit Oversupply Amount:</label><input type="number" name="kitOverSupplyAmount" value="${data.kitOverSupplyAmount || ''}" placeholder="Optional" min="0"></div>
                    <div class="input-group"><label>Kit Weight (kg):</label><input type="number" name="kitWeight" step="any" value="${data.kitWeight || ''}" placeholder="Optional" min="0"></div>
                </div>
            `;
            itemDiv.querySelector('.remove-dynamic-item').addEventListener('click', () => itemDiv.remove());
            container.appendChild(itemDiv);
        }
        function collectInterventionItemData(itemBlock) {
            return {
                _id: itemBlock.dataset.itemId,
                productName: itemBlock.querySelector('[name="productName"]').value,
                productType: itemBlock.querySelector('[name="productType"]').value ? parseInt(itemBlock.querySelector('[name="productType"]').value) : null,
                quantityType: itemBlock.querySelector('[name="quantityType"]').value ? parseInt(itemBlock.querySelector('[name="quantityType"]').value) : null,
                quantity: itemBlock.querySelector('[name="quantity"]').value ? parseInt(itemBlock.querySelector('[name="quantity"]').value) : null,
                oversupplyAmount: itemBlock.querySelector('[name="oversupplyAmount"]').value ? parseInt(itemBlock.querySelector('[name="oversupplyAmount"]').value) : null,
                supplyCountry: itemBlock.querySelector('[name="supplyCountry"]').value || null,
                kitQuantityType: itemBlock.querySelector('[name="kitQuantityType"]').value ? parseInt(itemBlock.querySelector('[name="kitQuantityType"]').value) : null,
                kitQuantity: itemBlock.querySelector('[name="kitQuantity"]').value ? parseInt(itemBlock.querySelector('[name="kitQuantity"]').value) : null,
                kitOverSupplyAmount: itemBlock.querySelector('[name="kitOverSupplyAmount"]').value ? parseInt(itemBlock.querySelector('[name="kitOverSupplyAmount"]').value) : null,
                kitWeight: itemBlock.querySelector('[name="kitWeight"]').value ? parseFloat(itemBlock.querySelector('[name="kitWeight"]').value) : null,
            };
        }

        let tlkItemCounter = 0;
        function createTestLabKitItemForm(container, data = {}) {
            tlkItemCounter++;
            const itemId = data._id || crypto.randomUUID();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'dynamic-section-block';
            itemDiv.id = `tlk-item-${tlkItemCounter}`;
            itemDiv.dataset.itemId = itemId;
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2"><h4 class="text-md font-semibold">Lab Kit #${tlkItemCounter}</h4><button type="button" class="btn btn-danger btn-sm remove-dynamic-item">Remove</button></div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                    <div class="input-group"><label>Product Name:</label><input type="text" name="productName" value="${data.productName || ''}"></div>
                    <div class="input-group"><label>Supply Country:</label><input type="text" name="supplyCountry" value="${data.supplyCountry || ''}" placeholder="Optional"></div>
                    <div class="input-group"><label>Kit Quantity Type (Num):</label><input type="number" name="kitQuantityType" value="${data.kitQuantityType || ''}"></div>
                    <div class="input-group"><label>Kit Quantity:</label><input type="number" name="kitQuantity" value="${data.kitQuantity || ''}" min="0"></div>
                    <div class="input-group"><label>Kit Oversupply Amount:</label><input type="number" name="kitOverSupplyAmount" value="${data.kitOverSupplyAmount || ''}" placeholder="Optional" min="0"></div>
                    <div class="input-group"><label>Kit Weight (kg):</label><input type="number" name="kitWeight" step="any" value="${data.kitWeight || ''}" min="0"></div>
                </div>
            `;
            itemDiv.querySelector('.remove-dynamic-item').addEventListener('click', () => itemDiv.remove());
            container.appendChild(itemDiv);
        }
        function collectTestLabKitItemData(itemBlock) {
             return {
                _id: itemBlock.dataset.itemId,
                productName: itemBlock.querySelector('[name="productName"]').value,
                supplyCountry: itemBlock.querySelector('[name="supplyCountry"]').value || null,
                kitQuantityType: itemBlock.querySelector('[name="kitQuantityType"]').value ? parseInt(itemBlock.querySelector('[name="kitQuantityType"]').value) : null,
                kitQuantity: itemBlock.querySelector('[name="kitQuantity"]').value ? parseInt(itemBlock.querySelector('[name="kitQuantity"]').value) : null,
                kitOverSupplyAmount: itemBlock.querySelector('[name="kitOverSupplyAmount"]').value ? parseInt(itemBlock.querySelector('[name="kitOverSupplyAmount"]').value) : null,
                kitWeight: itemBlock.querySelector('[name="kitWeight"]').value ? parseFloat(itemBlock.querySelector('[name="kitWeight"]').value) : null,
            };
        }
        
        let opdItemCounter = 0;
        function createOtherParticipantItemForm(container, data = {}) {
            opdItemCounter++;
            const itemId = data._id || crypto.randomUUID();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'dynamic-section-block';
            itemDiv.id = `opd-item-${opdItemCounter}`;
            itemDiv.dataset.itemId = itemId;
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2"><h4 class="text-md font-semibold">Device #${opdItemCounter}</h4><button type="button" class="btn btn-danger btn-sm remove-dynamic-item">Remove</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                    <div class="input-group"><label>Product Name:</label><input type="text" name="productName" value="${data.productName || ''}"></div>
                    <div class="input-group"><label>Supply Country:</label><input type="text" name="supplyCountry" value="${data.supplyCountry || ''}" placeholder="Optional"></div>
                    <div class="input-group"><label>Product Type:</label><input type="text" name="productType" value="${data.productType || 'Device_(smartphone)'}"></div>
                    <div class="input-group"><label>Item Weight (kg):</label><input type="number" name="itemWeight" step="any" value="${data.itemWeight || ''}" min="0"></div>
                    <div class="input-group"><label>Quantity Type (Num):</label><input type="number" name="quantityType" value="${data.quantityType || ''}"></div>
                    <div class="input-group"><label>Quantity:</label><input type="number" name="quantity" value="${data.quantity || ''}" min="0"></div>
                    <div class="input-group"><label>Oversupply Amount:</label><input type="number" name="overSupplyAmount" value="${data.overSupplyAmount || ''}" placeholder="Optional" min="0"></div>
                    <div class="input-group"><label>Hours Usage/Device/Participant:</label><input type="number" name="hoursUsagePerDevicePerParticipant" value="${data.hoursUsagePerDevicePerParticipant || ''}" min="0"></div>
                </div>
            `;
            itemDiv.querySelector('.remove-dynamic-item').addEventListener('click', () => itemDiv.remove());
            container.appendChild(itemDiv);
        }
        function collectOtherParticipantItemData(itemBlock) {
            return {
                _id: itemBlock.dataset.itemId,
                productName: itemBlock.querySelector('[name="productName"]').value,
                supplyCountry: itemBlock.querySelector('[name="supplyCountry"]').value || null,
                productType: itemBlock.querySelector('[name="productType"]').value,
                itemWeight: itemBlock.querySelector('[name="itemWeight"]').value ? parseFloat(itemBlock.querySelector('[name="itemWeight"]').value) : null,
                quantityType: itemBlock.querySelector('[name="quantityType"]').value ? parseInt(itemBlock.querySelector('[name="quantityType"]').value) : null,
                quantity: itemBlock.querySelector('[name="quantity"]').value ? parseInt(itemBlock.querySelector('[name="quantity"]').value) : null,
                overSupplyAmount: itemBlock.querySelector('[name="overSupplyAmount"]').value ? parseInt(itemBlock.querySelector('[name="overSupplyAmount"]').value) : null,
                hoursUsagePerDevicePerParticipant: itemBlock.querySelector('[name="hoursUsagePerDevicePerParticipant"]').value ? parseInt(itemBlock.querySelector('[name="hoursUsagePerDevicePerParticipant"]').value) : null,
            };
        }

        // --- Build Final Payload for API ---
        function buildApiPayload() {
            const payload = {
                currencyCode: appData.generalInfo?.['gi-currencyCode'] || null,
                trialName: appData.generalInfo?.['gi-trialName'] || null,
                individualName: appData.generalInfo?.['gi-individualName'] || null,
                startDate: appData.generalInfo?.['gi-startDate'] ? `${appData.generalInfo['gi-startDate']}:00.000Z` : null,
                endDate: appData.generalInfo?.['gi-endDate'] ? `${appData.generalInfo['gi-endDate']}:00.000Z` : null,
                countryDetails: (appData.countryDetails || []).map(item => ({
                    countryCode: item.countryCode || null,
                    numberOfSubjects: item.numberOfSubjects || 0,
                    siteVisit: { 
                        numberOfSubjectSiteVisits: item.siteVisit_numberOfSubjectSiteVisits || 0, 
                        durationOfVisit: item.siteVisit_durationOfVisit || 0 
                    },
                    remoteVirtualVisit: { 
                        numberOfRemoveVirtualVists: item.remoteVirtualVisit_numberOfRemoveVirtualVists || 0, 
                        durationOfVisit: item.remoteVirtualVisit_durationOfVisit || 0 
                    }
                })),
                interventions: (appData.interventions || []).map(item => ({ 
                    id: item._id || crypto.randomUUID(), 
                    productName: item.productName || null, 
                    productType: item.productType === '' ? null : item.productType, 
                    quantityType: item.quantityType === '' ? null : item.quantityType, 
                    quantity: item.quantity === '' ? null : item.quantity,
                    oversupplyAmount: item.oversupplyAmount === '' ? null : item.oversupplyAmount,
                    supplyCountry: item.supplyCountry || null,
                    kitQuantityType: item.kitQuantityType === '' ? null : item.kitQuantityType,
                    kitQuantity: item.kitQuantity === '' ? null : item.kitQuantity,
                    kitOverSupplyAmount: item.kitOverSupplyAmount === '' ? null : item.kitOverSupplyAmount,
                    kitWeight: item.kitWeight === '' ? null : item.kitWeight
                })),
                testLabKit: (appData.testLabKits || []).map(item => ({
                    id: item._id || crypto.randomUUID(), 
                    productName: item.productName || null,
                    supplyCountry: item.supplyCountry || null,
                    kitQuantityType: item.kitQuantityType === '' ? null : item.kitQuantityType,
                    kitQuantity: item.kitQuantity === '' ? null : item.kitQuantity,
                    kitOverSupplyAmount: item.kitOverSupplyAmount === '' ? null : item.kitOverSupplyAmount,
                    kitWeight: item.kitWeight === '' ? null : item.kitWeight
                })),
                otherParticipants: (appData.otherParticipants || []).map(item => ({
                    id: item._id || crypto.randomUUID(), 
                    productName: item.productName || null,
                    supplyCountry: item.supplyCountry || null,
                    productType: item.productType || null,
                    itemWeight: item.itemWeight === '' ? null : item.itemWeight,
                    quantityType: item.quantityType === '' ? null : item.quantityType,
                    quantity: item.quantity === '' ? null : item.quantity,
                    overSupplyAmount: item.overSupplyAmount === '' ? null : item.overSupplyAmount,
                    hoursUsagePerDevicePerParticipant: item.hoursUsagePerDevicePerParticipant === '' ? null : item.hoursUsagePerDevicePerParticipant
                }))
            };
            
            return payload;
        }

        // --- Calculate Results ---
        async function handleCalculateResults() {
            resultsLoadingIndicator.style.display = 'block';
            resultsContent.innerHTML = '';
            if (emissionsChartInstance) { emissionsChartInstance.destroy(); emissionsChartInstance = null;}
            emissionsChartCanvas.getContext('2d').clearRect(0,0,emissionsChartCanvas.width, emissionsChartCanvas.height);

            const payload = buildApiPayload();
            console.log("Sending API Payload:", JSON.stringify(payload, null, 2));

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    console.error("API request failed. Status:", response.status, "StatusText:", response.statusText);
                    let errorDetail = `HTTP error! Status: ${response.status}`;
                    if(response.statusText) errorDetail += ` (${response.statusText})`;
                    try {
                        const errorBody = await response.text(); 
                        console.error("Error response body:", errorBody);
                        errorDetail += ` - Response: ${errorBody.substring(0, 500)}${errorBody.length > 500 ? '...' : ''}`; 
                    } catch (e) {
                        console.warn("Could not read error response body:", e);
                         errorDetail += " (Could not read error response body)";
                    }
                    throw new Error(errorDetail);
                }

                const result = await response.json();
                latestApiResult = result; // Store for CSV export
                displayApiResults(result); 
            } catch (error) {
                console.error('Error during API request or processing:', error);
                resultsContent.innerHTML = `<div class="result-card text-red-600"><h3 class="text-red-700">Error</h3><p>Failed to calculate results. Details: ${error.message || 'Unknown error'}</p><p>Please check the browser console (Network tab and Console tab) for more information.</p></div>`;
                latestApiResult = null; // Clear on error
            } finally {
                resultsLoadingIndicator.style.display = 'none';
                showPage('resultsPage');
            }
        }
        
        function displayApiResults(data) { 
            resultsContent.innerHTML = ''; 

            const totalsCard = document.createElement('div');
            totalsCard.className = 'result-card';
            totalsCard.innerHTML = `<h3>Overall Emissions</h3>
                ${createResultItem('Total kgCO2e', data.totalKgCO2e, 'kgCO2e')}
                ${createResultItem('Total kgCO2e (Scope 3)', data.totalKgCO2eSp3, 'kgCO2e')}
                ${createResultItem('Participant kgCO2e', data.participantKgCO2e, 'kgCO2e/participant')}
                ${createResultItem('Participant kgCO2e (Scope 3)', data.participantKgCO2eSp3, 'kgCO2e/participant')}`;
            resultsContent.appendChild(totalsCard);

            const displayGenericSectionResults = (sectionData, title) => {
                if (sectionData && Array.isArray(sectionData) && sectionData.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    let html = `<h3>${title}</h3>`;
                    sectionData.forEach((item, index) => {
                        html += `<div class="border-t pt-3 mt-3 first:border-t-0 first:pt-0 first:mt-0"><h4>Item Result #${index + 1}</h4>`;
                        for (const key in item) {
                             if (typeof item[key] !== 'object' || item[key] === null) {
                                html += createResultItem(key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), item[key]);
                            }
                        }
                        html += createDebugLogs(item.debugLogs); 
                        html += `</div>`;
                    });
                    card.innerHTML = html;
                    resultsContent.appendChild(card);
                } else if (sectionData && typeof sectionData === 'object' && !Array.isArray(sectionData)) { 
                     const card = document.createElement('div');
                     card.className = 'result-card';
                     let html = `<h3>${title}</h3>`;
                     for(const key in sectionData){
                         if (key !== 'debugLogs' && (typeof sectionData[key] !== 'object' || sectionData[key] === null)) {
                            html += createResultItem(key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), sectionData[key]);
                         } else if (key !== 'debugLogs' && typeof sectionData[key] === 'object' && sectionData[key] !== null) {
                            html += `<div class="ml-4 mt-2"><h5>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</h5>`;
                            for (const subKey in sectionData[key]) {
                                 if (subKey !== 'debugLogs' && (typeof sectionData[key][subKey] !== 'object' || sectionData[key][subKey] === null)) {
                                    html += createResultItem(subKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), sectionData[key][subKey], '', 'ml-2');
                                 }
                            }
                            html += createDebugLogs(sectionData[key].debugLogs);
                            html += `</div>`;
                         }
                     }
                     html += createDebugLogs(sectionData.debugLogs);
                     card.innerHTML = html;
                     resultsContent.appendChild(card);
                }
            };
            
            displayGenericSectionResults(data.interventionResults, "Intervention Results");
            displayGenericSectionResults(data.participantTravelResult, "Participant Travel Results"); 
            displayGenericSectionResults(data.testLabKit, "Test Lab Kit Results"); 
            displayGenericSectionResults(data.otherParticipants, "Other Participant Devices Results"); 
            displayGenericSectionResults(data.countryEmissionBreakdown, "Country Emission Breakdown");
            
            if (data.samples) {
                const samplesCard = document.createElement('div');
                samplesCard.className = 'result-card';
                samplesCard.innerHTML = `<h3>Samples</h3>
                    ${createResultItem('Analysis', data.samples.analysis, 'kgCO2e')} 
                    ${createResultItem('Shipment', data.samples.shipment, 'kgCO2e')}
                    ${createResultItem('Storage', data.samples.storage, 'kgCO2e')}
                    ${createResultItem('End of Life', data.samples.endOfLife, 'kgCO2e')}
                    ${createDebugLogs(data.samples.debugLogs)}`;
                resultsContent.appendChild(samplesCard);
            }

            if (data.sectionEmissionBreakdown && data.sectionEmissionBreakdown.length > 0) {
                const chartLabels = data.sectionEmissionBreakdown.map(s => s.sectionName);
                const chartDataValues = data.sectionEmissionBreakdown.map(s => s.totalKgCO2e);
                if (emissionsChartInstance) emissionsChartInstance.destroy();
                emissionsChartInstance = new Chart(emissionsChartCanvas, {
                    type: 'bar', data: { labels: chartLabels, datasets: [{ label: 'kgCO2e', data: chartDataValues, 
                    backgroundColor: ['rgba(54, 162, 235, 0.6)','rgba(255, 99, 132, 0.6)','rgba(75, 192, 192, 0.6)','rgba(255, 206, 86, 0.6)','rgba(153, 102, 255, 0.6)','rgba(255, 159, 64, 0.6)','rgba(199, 199, 199, 0.6)'],
                    borderColor: ['rgba(54, 162, 235, 1)','rgba(255, 99, 132, 1)','rgba(75, 192, 192, 1)','rgba(255, 206, 86, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(199, 199, 199, 1)'],
                    borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'kgCO2e' }}, x: { title: { display: true, text: 'Emission Section' }}}, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} kgCO2e` }}} }
                });
            } else {
                 if (emissionsChartInstance) { emissionsChartInstance.destroy(); emissionsChartInstance = null; }
                 emissionsChartCanvas.getContext('2d').clearRect(0,0,emissionsChartCanvas.width, emissionsChartCanvas.height);
            }

            rawApiResponseElement.textContent = JSON.stringify(data, null, 2);
            rawApiResponseElement.classList.add('hidden');
            toggleRawJsonButton.textContent = 'Show Raw JSON';
        }

        // --- CSV Export Function ---
        function exportResultsToCsv() {
            if (!latestApiResult) {
                alert("No results available to export. Please calculate results first.");
                return;
            }

            const data = latestApiResult;
            let csvContent = "data:text/csv;charset=utf-8,";

            // Helper to sanitize CSV data
            const sanitize = (value) => {
                if (value === null || typeof value === 'undefined') return "";
                let strValue = String(value);
                if (strValue.includes(",")) strValue = `"${strValue}"`; // Enclose in quotes if contains comma
                return strValue;
            };
            
            // Section Emission Breakdown
            csvContent += "Section Emission Breakdown\r\n";
            csvContent += "Section Name,Section Number,Percentage,Total kgCO2e,Total kgCO2e (Scope 3)\r\n";
            if (data.sectionEmissionBreakdown && data.sectionEmissionBreakdown.length > 0) {
                data.sectionEmissionBreakdown.forEach(row => {
                    csvContent += [
                        sanitize(row.sectionName),
                        sanitize(row.sectionNumber),
                        sanitize(row.percentage),
                        sanitize(row.totalKgCO2e),
                        sanitize(row.totalKgCO2eSp3)
                    ].join(",") + "\r\n";
                });
            }
            csvContent += "\r\n"; // Add a blank line

            // Overall Totals
            csvContent += "Overall Trial Totals\r\n";
            csvContent += "Metric,Value\r\n";
            csvContent += `Total kgCO2e,${sanitize(data.totalKgCO2e)}\r\n`;
            csvContent += `Total kgCO2e (Scope 3),${sanitize(data.totalKgCO2eSp3)}\r\n`;
            csvContent += `Participant kgCO2e,${sanitize(data.participantKgCO2e)}\r\n`;
            csvContent += `Participant kgCO2e (Scope 3),${sanitize(data.participantKgCO2eSp3)}\r\n`;
            csvContent += "\r\n";

            // Country Emission Breakdown
            csvContent += "Country Emission Breakdown\r\n";
            csvContent += "Country Code,Total kgCO2e,Total kgCO2e (Scope 3)\r\n";
            if (data.countryEmissionBreakdown && data.countryEmissionBreakdown.length > 0) {
                data.countryEmissionBreakdown.forEach(row => {
                    csvContent += [
                        sanitize(row.countryCode),
                        sanitize(row.totalKgCO2e),
                        sanitize(row.totalKgCO2eSp3)
                    ].join(",") + "\r\n";
                });
            }
            csvContent += "\r\n";
            
            // Intervention Results (Example - adjust based on desired columns)
            csvContent += "Intervention Results\r\n";
            csvContent += "ID,Manufacture kgCO2e,Supply kgCO2e,End of Life kgCO2e,Manufacture kgCO2e (Scope 3),Supply kgCO2e (Scope 3),End of Life kgCO2e (Scope 3)\r\n";
            if (data.interventionResults && data.interventionResults.length > 0) {
                data.interventionResults.forEach(row => {
                    csvContent += [
                        sanitize(row.id), sanitize(row.manufacture), sanitize(row.supply), sanitize(row.endOfLife),
                        sanitize(row.manufactureSp3), sanitize(row.supplySp3), sanitize(row.endOfLifeSp3)
                    ].join(",") + "\r\n";
                });
            }
            csvContent += "\r\n";

            // Test Lab Kit Results (Example)
            csvContent += "Test Lab Kit Results\r\n";
            csvContent += "ID,Manufacture kgCO2e,Supply kgCO2e,End of Life kgCO2e,Manufacture kgCO2e (Scope 3),Supply kgCO2e (Scope 3),End of Life kgCO2e (Scope 3)\r\n";
             if (data.testLabKit && data.testLabKit.length > 0) { // Note: API response has 'testLabKit' not 'testLabKitResults'
                data.testLabKit.forEach(row => {
                    csvContent += [
                        sanitize(row.id), sanitize(row.manufacture), sanitize(row.supply), sanitize(row.endOfLife),
                        sanitize(row.manufactureSp3), sanitize(row.supplySp3), sanitize(row.endOfLifeSp3)
                    ].join(",") + "\r\n";
                });
            }
            csvContent += "\r\n";

            // Other Participant Devices Results (Example)
            csvContent += "Other Participant Devices Results\r\n";
            csvContent += "ID,Usage kgCO2e,Manufacture kgCO2e,Supply kgCO2e,End of Life kgCO2e,Usage kgCO2e (Scope 3),Manufacture kgCO2e (Scope 3),Supply kgCO2e (Scope 3),End of Life kgCO2e (Scope 3)\r\n";
            if (data.otherParticipants && data.otherParticipants.length > 0) { // Note: API response has 'otherParticipants'
                data.otherParticipants.forEach(row => {
                    csvContent += [
                        sanitize(row.id), sanitize(row.usage), sanitize(row.manufacture), sanitize(row.supply), sanitize(row.endOfLife),
                        sanitize(row.usageSp3), sanitize(row.manufactureSp3), sanitize(row.supplySp3), sanitize(row.endOfLifeSp3)
                    ].join(",") + "\r\n";
                });
            }
            csvContent += "\r\n";


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "clinical_trial_carbon_results.csv");
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }


        // --- Event Listeners ---
        newAssessmentButton.addEventListener('click', resetAssessment);
        calculateResultsButtonOverview.addEventListener('click', handleCalculateResults);
        backToOverviewButton.addEventListener('click', () => showPage('overviewPage'));
        exportCsvButton.addEventListener('click', exportResultsToCsv); // Listener for new button
        
        toggleRawJsonButton.addEventListener('click', () => {
            rawApiResponseElement.classList.toggle('hidden');
            toggleRawJsonButton.textContent = rawApiResponseElement.classList.contains('hidden') ? 'Show Raw JSON' : 'Hide Raw JSON';
        });

        sectionEditViewsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('cancel-section-edit')) {
                showPage('overviewPage');
            }
        });
        sectionEditViewsContainer.addEventListener('submit', (e) => { 
            if (e.target.closest('form')) { 
                 handleSaveSection(e);
            }
        });
        
        sections.filter(s => s.addItemButtonId).forEach(sectionDef => {
            const button = document.getElementById(sectionDef.addItemButtonId);
            if (button) { 
                button.addEventListener('click', () => {
                    const container = document.getElementById(sectionDef.dynamicItemsContainerId);
                    if (typeof window[sectionDef.itemCreationFn] === 'function') {
                        window[sectionDef.itemCreationFn](container, {}); 
                    }
                });
            }
        });

        // --- Initial Load ---
        initializeAppData();
        renderOverviewCards();
        showPage('overviewPage');

    </script>
</body>
</html>
